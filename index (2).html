<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ClickMoz - Painel do Usu치rio</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/a2e0e6e6c3.js" crossorigin="anonymous"></script>
  <style>
    body {
      background-color: #fff8dc;
      font-family: 'Segoe UI', sans-serif;
    }
    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .sidebar {
      height: 100vh;
      background-color: #ffc107;
      padding-top: 2rem;
      position: fixed;
      width: 240px;
      overflow-y: auto;
    }
    .sidebar a {
      display: block;
      padding: 1rem;
      color: #000;
      text-decoration: none;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    .sidebar a:hover, .sidebar a.active {
      background-color: #ffca28;
    }
    .main {
      margin-left: 250px;
      padding: 2rem;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .saldo {
      font-size: 2rem;
      font-weight: bold;
    }
    #loadingOverlay {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.5rem;
      color: #ffc107;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <div id="loadingOverlay">Carregando dados...</div>

  <div class="sidebar">
    <h4 class="text-center mb-4">ClickMoz</h4>
    <a href="#" class="active"><i class="fas fa-home"></i> In칤cio</a>
    <a href="#"><i class="fas fa-coins"></i> Ganhar Tarefas</a>
    <a href="#"><i class="fas fa-money-bill-wave"></i> Levantar</a>
    <a href="#"><i class="fas fa-share-alt"></i> Partilhar e Ganhar</a>
    <a href="#"><i class="fas fa-user"></i> Perfil</a>
    <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</a>
  </div>

  <div class="main">
    <div class="header mb-4">
      <h2>Ol치, <span id="nomeUsuario">Usu치rio</span> 游녦</h2>
      <button class="btn btn-outline-dark" onclick="logout()">Sair</button>
    </div>

    <div class="row g-4">
      <div class="col-md-4">
        <div class="card text-center p-3">
          <h5>Seu saldo</h5>
          <div class="saldo" id="saldoUsuario">0 MT</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-center p-3">
          <h5>Levantar</h5>
          <button class="btn btn-success mt-2" data-bs-toggle="modal" data-bs-target="#modalSaque">Solicitar Saque</button>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-center p-3">
          <h5>Partilhar e Ganhar</h5>
          <button class="btn btn-warning mt-2" id="btnCopiarLink">Copiar Link</button>
          <small id="msgLinkCopiado" class="text-success d-none">Link copiado!</small>
        </div>
      </div>
    </div>

    <hr class="my-4" />

    <h4>Tarefas dispon칤veis</h4>
    <ul class="list-group mb-4" id="listaTarefas"></ul>

    <h4>Hist칩rico de Transa칞칫es</h4>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Data</th>
          <th>Tipo</th>
          <th>Valor</th>
        </tr>
      </thead>
      <tbody id="historicoTransacoes"></tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, query, where, getDocs, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD70Uto5Z8gAHclBNm9peW7FKd4pR1-sZA",
      authDomain: "clickmoz-e7e6b.firebaseapp.com",
      projectId: "clickmoz-e7e6b",
      storageBucket: "clickmoz-e7e6b.appspot.com",
      messagingSenderId: "57111705800",
      appId: "1:57111705800:web:6ff95f2ce510c0c09f8dfd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const listaTarefas = document.getElementById("listaTarefas");
    const nomeUsuario = document.getElementById("nomeUsuario");
    const saldoUsuario = document.getElementById("saldoUsuario");
    const loadingOverlay = document.getElementById("loadingOverlay");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      const uid = user.uid;
      const docSnap = await getDoc(doc(db, "usuarios", uid));
      if (!docSnap.exists()) return;

      const userData = docSnap.data();
      nomeUsuario.textContent = userData.nome || "Usu치rio";
      saldoUsuario.textContent = `${(userData.saldo || 0).toFixed(2)} MT`;

      // Buscar tarefas aprovadas
      const tarefasSnap = await getDocs(query(collection(db, "tasks"), where("approved", "==", true)));
      listaTarefas.innerHTML = "";

      if (tarefasSnap.empty) {
        listaTarefas.innerHTML = '<li class="list-group-item">Nenhuma tarefa dispon칤vel no momento.</li>';
      } else {
        tarefasSnap.forEach((doc) => {
          const tarefa = doc.data();
          const li = document.createElement("li");
          li.className = "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `
            ${tarefa.title || "Sem t칤tulo"} - ${tarefa.description || ""}
            <button class="btn btn-sm btn-primary">Fazer</button>
          `;
          listaTarefas.appendChild(li);
        });
      }

      loadingOverlay.style.display = "none";
    });

    function logout() {
      signOut(auth).then(() => {
        window.location.href = "index.html";
      });
    }
  </script>
</body>
</html>
